---
- name: HyperRegistry | Create values.yml
  template:
    src: "{{ item }}.j2"
    dest: "{{ kube_config_dir }}/addons/hyperregistry/{{ item }}"
  with_items: ["hr-traefik-values.yml"]

- name: HyperRegistry | Check if it was installed
  shell: |
    /usr/local/bin/helm status {{ hyperregistry_release_name }} -n {{ hyperregistry_namespace }}
  register: already_installed_result
  failed_when:
    - already_installed_result.rc != 0

- name: HyperRegistry | Upgrade HyperRegistry used for Traefik ingress
  shell: |
    /usr/local/bin/helm upgrade {{ hyperregistry_release_name }} {{ chart }} -n {{ hyperregistry_namespace }} -f {{ values }}
  vars:
    - chart: "{{ hyperregistry_download_url | regex_replace('^file://', '') }}"
    - values: "{{ kube_config_dir }}/addons/hyperregistry/hr-traefik-values.yml"
  when:
    - already_installed_result.rc == 0
